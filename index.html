<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="theme-color" content="#0b0e17">
  <title>QuizForge - 試験問題演習</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------------------------------------------
       DESIGN TOKENS
    --------------------------------------------------- */
    :root {
      --bg:       #0b0e17;
      --card:     #131720;
      --card2:    #1a2030;
      --border:   #252d3d;
      --border2:  #2e3a50;
      --accent:   #4f9eff;
      --accent-g: #00e5a0;
      --text:     #e0e8f8;
      --muted:    #7a8aaa;
      --dim:      #9ba8c0;
      --correct:  #22c57a;
      --wrong:    #f05252;
      --r:        12px;
      --rl:       18px;
      --rx:       24px;
    }

    /* ---------------------------------------------------
       RESET & BASE
    --------------------------------------------------- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    a { color: inherit; text-decoration: none; }

    /* subtle grid */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(79,158,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(79,158,255,.03) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    /* ---------------------------------------------------
       HEADER
    --------------------------------------------------- */
    .site-header {
      position: fixed;
      inset: 0 0 auto 0;
      z-index: 300;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      background: rgba(11,14,23,.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-family: 'Space Mono', monospace;
      font-size: .95rem;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: .4rem;
      cursor: pointer;
      user-select: none;
    }
    .logo b { color: var(--text); }
    .logo-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--accent-g);
      box-shadow: 0 0 6px var(--accent-g);
    }
    .header-tag {
      font-family: 'Space Mono', monospace;
      font-size: .58rem;
      letter-spacing: .1em;
      color: var(--muted);
      border: 1px solid var(--border2);
      padding: 2px 8px;
      border-radius: 20px;
    }

    /* ---------------------------------------------------
       VIEWS
    --------------------------------------------------- */
    main { position: relative; z-index: 1; padding-top: 52px; }
    .view { display: none; }
    .view.active {
      display: block;
      animation: slideUp .28s cubic-bezier(.4,0,.2,1);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* shared container */
    .page { max-width: 680px; margin: 0 auto; padding: 1.5rem 1rem 5rem; }
    .page-wide { max-width: 980px; margin: 0 auto; padding: 1.5rem 1rem 5rem; }

    /* ---------------------------------------------------
       SECTION TITLE (shared)
    --------------------------------------------------- */
    .section-label {
      font-family: 'Space Mono', monospace;
      font-size: .62rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: .6rem;
    }

    /* ---------------------------------------------------
       HOME
    --------------------------------------------------- */
    .hero {
      text-align: center;
      padding: 2rem 0 2.5rem;
    }
    .hero-title {
      font-size: clamp(1.8rem, 5vw, 2.8rem);
      font-weight: 900;
      letter-spacing: -.03em;
      line-height: 1.15;
      margin-bottom: .75rem;
    }
    .hero-title em {
      font-style: normal;
      background: linear-gradient(120deg, var(--accent-g), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-sub {
      color: var(--dim);
      font-size: .9rem;
      max-width: 380px;
      margin: 0 auto;
    }

    /* Subject blocks */
    .subject-block { margin-bottom: 2.5rem; }
    .subject-head {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding-bottom: .7rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .subject-head-icon { font-size: 1.2rem; }
    .subject-head-name { font-size: 1rem; font-weight: 700; color: #fff; }
    .subject-head-desc { font-size: .75rem; color: var(--muted); margin-left: .15rem; }

    /* Exam accordion */
    .exam-block {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      margin-bottom: .75rem;
      overflow: hidden;
      transition: border-color .2s;
    }
    .exam-block.open { border-color: var(--border2); }

    .exam-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .9rem 1rem;
      text-align: left;
      background: none;
      cursor: pointer;
      transition: background .15s;
    }
    .exam-trigger:hover { background: rgba(255,255,255,.03); }
    .exam-trigger:active { background: rgba(255,255,255,.06); }

    .exam-badge {
      font-family: 'Space Mono', monospace;
      font-size: .6rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .exam-name { font-size: .93rem; font-weight: 700; flex: 1; text-align: left; color: #fff; }
    .exam-level {
      font-family: 'Space Mono', monospace;
      font-size: .58rem;
      color: var(--muted);
      border: 1px solid var(--border2);
      padding: 2px 7px;
      border-radius: 5px;
      flex-shrink: 0;
      display: none;
    }
    @media (min-width: 480px) { .exam-level { display: block; } }
    .exam-arrow {
      font-size: .7rem;
      color: var(--muted);
      transition: transform .2s;
      flex-shrink: 0;
    }
    .exam-block.open .exam-arrow { transform: rotate(180deg); }

    /* Sections grid */
    .sections-wrap {
      display: none;
      padding: .25rem .75rem .75rem;
      border-top: 1px solid var(--border);
    }
    .exam-block.open .sections-wrap { display: block; }

    .sections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: .5rem;
      padding-top: .5rem;
    }
    @media (max-width: 420px) {
      .sections-grid { grid-template-columns: 1fr 1fr; }
    }

    .sec-card {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: .85rem .9rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: .3rem;
      transition: all .18s;
      position: relative;
      overflow: hidden;
    }
    .sec-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--c, var(--accent));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .22s;
    }
    .sec-card:hover { border-color: rgba(255,255,255,.16); transform: translateY(-1px); }
    .sec-card:hover::before { transform: scaleX(1); }
    .sec-card:active { transform: scale(.98); }

    .sec-card.coming {
      opacity: .4;
      cursor: default;
    }
    .sec-card.coming:hover { transform: none; border-color: var(--border); }
    .sec-card.coming:hover::before { transform: scaleX(0); }

    .sec-icon { font-size: 1.2rem; }
    .sec-name { font-size: .82rem; font-weight: 700; line-height: 1.3; color: #fff; }
    .sec-desc { font-size: .7rem; color: var(--muted); line-height: 1.4; }
    .sec-count {
      font-family: 'Space Mono', monospace;
      font-size: .62rem;
      margin-top: .15rem;
    }
    .sec-soon {
      font-family: 'Space Mono', monospace;
      font-size: .55rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      border: 1px solid var(--border2);
      padding: 1px 6px;
      border-radius: 4px;
      align-self: flex-start;
    }

    /* -------------------
       SETUP MODAL (question count selector)
    ------------------- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0,0,0,.65);
      align-items: flex-end;
      justify-content: center;
      padding: 0;
    }
    @media (min-width: 600px) {
      .modal-overlay { align-items: center; padding: 1rem; }
    }
    .modal-overlay.show { display: flex; animation: fadeIn .2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-box {
      background: var(--card);
      border: 1px solid var(--border2);
      border-radius: var(--rx) var(--rx) 0 0;
      padding: 1.5rem 1.25rem 2rem;
      width: 100%;
      max-width: 480px;
      animation: slideModal .25s cubic-bezier(.4,0,.2,1);
    }
    @media (min-width: 600px) {
      .modal-box { border-radius: var(--rx); }
    }
    @keyframes slideModal {
      from { transform: translateY(30px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    .modal-drag {
      width: 40px; height: 4px;
      background: var(--border2);
      border-radius: 2px;
      margin: 0 auto 1.25rem;
    }
    @media (min-width: 600px) { .modal-drag { display: none; } }

    .modal-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: .3rem;
    }
    .modal-sub {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 1.25rem;
    }
    .modal-genre-name {
      color: var(--accent);
    }

    /* Count picker */
    .count-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: .5rem;
      margin-bottom: 1.25rem;
    }
    .count-btn {
      background: var(--card2);
      border: 2px solid var(--border);
      border-radius: var(--r);
      padding: .7rem .4rem;
      text-align: center;
      cursor: pointer;
      transition: all .15s;
    }
    .count-btn:hover { border-color: var(--accent); }
    .count-btn.selected {
      border-color: var(--accent);
      background: rgba(79,158,255,.1);
    }
    .count-btn-num {
      font-family: 'Space Mono', monospace;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
    }
    .count-btn-label {
      font-size: .65rem;
      color: var(--muted);
      margin-top: .2rem;
    }
    .count-btn.selected .count-btn-num { color: var(--accent); }

    /* custom input */
    .count-custom {
      margin-bottom: 1.25rem;
    }
    .count-custom label {
      font-size: .8rem;
      color: var(--dim);
      display: block;
      margin-bottom: .4rem;
    }
    .count-custom input {
      width: 100%;
      background: var(--card2);
      border: 2px solid var(--border);
      border-radius: var(--r);
      padding: .6rem .9rem;
      color: var(--text);
      font-size: 1rem;
      font-family: 'Space Mono', monospace;
      outline: none;
      transition: border-color .15s;
    }
    .count-custom input:focus { border-color: var(--accent); }

    .modal-actions {
      display: flex;
      gap: .6rem;
    }
    .btn-cancel {
      flex: 0 0 auto;
      padding: .75rem 1.2rem;
      border-radius: var(--r);
      border: 1px solid var(--border2);
      color: var(--muted);
      font-size: .9rem;
      font-weight: 700;
      transition: all .15s;
    }
    .btn-cancel:hover { color: var(--text); border-color: var(--muted); }
    .btn-start {
      flex: 1;
      padding: .75rem;
      border-radius: var(--r);
      background: var(--accent);
      color: #050d1a;
      font-size: .95rem;
      font-weight: 700;
      transition: all .18s;
    }
    .btn-start:hover { background: #74b7ff; box-shadow: 0 0 20px rgba(79,158,255,.35); }
    .btn-start:active { transform: scale(.98); }

    /* -------------------
       QUIZ PAGE
    ------------------- */
    /* Breadcrumb */
    .quiz-nav {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .35rem;
      margin-bottom: 1rem;
      font-size: .76rem;
      color: var(--muted);
    }
    .quiz-nav a {
      color: var(--accent);
      cursor: pointer;
    }
    .quiz-nav a:hover { text-decoration: underline; }
    .quiz-nav-sep { color: var(--border2); }

    /* Progress header */
    .quiz-progress {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: .9rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .qp-info { flex: 1; min-width: 0; }
    .qp-row {
      display: flex;
      justify-content: space-between;
      font-size: .72rem;
      color: var(--muted);
      margin-bottom: .35rem;
      font-family: 'Space Mono', monospace;
    }
    .qp-bar-track {
      height: 5px;
      background: var(--border);
      border-radius: 5px;
      overflow: hidden;
    }
    .qp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-g), var(--accent));
      border-radius: 5px;
      transition: width .45s cubic-bezier(.4,0,.2,1);
    }
    .qp-score {
      text-align: center;
      flex-shrink: 0;
    }
    .qp-score-num {
      font-family: 'Space Mono', monospace;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent-g);
      line-height: 1;
    }
    .qp-score-den {
      font-family: 'Space Mono', monospace;
      font-size: .65rem;
      color: var(--muted);
    }

    /* Question card */
    .q-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: 1.25rem 1.1rem;
      margin-bottom: .75rem;
    }
    .q-num {
      font-family: 'Space Mono', monospace;
      font-size: .62rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: .6rem;
    }
    .q-text {
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    /* Choices */
    .choices { display: flex; flex-direction: column; gap: .5rem; margin-bottom: .75rem; }

    .choice {
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: var(--r);
      padding: .8rem .9rem;
      display: flex;
      align-items: flex-start;
      gap: .7rem;
      cursor: pointer;
      text-align: left;
      color: var(--text);
      font-size: .92rem;
      line-height: 1.5;
      width: 100%;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .choice:hover:not(:disabled) {
      border-color: rgba(255,255,255,.2);
      background: var(--card2);
    }
    .choice:active:not(:disabled) { transform: scale(.99); }
    .choice:disabled { cursor: default; }

    .choice-key {
      font-family: 'Space Mono', monospace;
      font-size: .65rem;
      font-weight: 700;
      min-width: 22px;
      height: 22px;
      border-radius: 5px;
      background: var(--card2);
      border: 1px solid var(--border2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
      transition: all .15s;
    }
    .choice.correct {
      border-color: var(--correct);
      background: rgba(34,197,122,.07);
    }
    .choice.correct .choice-key {
      background: var(--correct);
      color: #051a0e;
      border-color: var(--correct);
    }
    .choice.wrong {
      border-color: var(--wrong);
      background: rgba(240,82,82,.07);
    }
    .choice.wrong .choice-key {
      background: var(--wrong);
      color: white;
      border-color: var(--wrong);
    }

    /* Result badge */
    .result-badge {
      display: none;
      padding: .65rem;
      border-radius: var(--r);
      font-weight: 700;
      font-size: .92rem;
      text-align: center;
      margin-bottom: .65rem;
    }
    .result-badge.show { display: block; animation: pop .28s cubic-bezier(.34,1.56,.64,1); }
    @keyframes pop { from { transform: scale(.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .result-badge.correct { background: rgba(34,197,122,.1); color: var(--correct); border: 1px solid rgba(34,197,122,.25); }
    .result-badge.wrong   { background: rgba(240,82,82,.08); color: var(--wrong);   border: 1px solid rgba(240,82,82,.2); }

    /* Explanation */
    .explanation {
      display: none;
      background: var(--card2);
      border-left: 3px solid var(--accent-g);
      border-radius: 0 var(--r) var(--r) 0;
      padding: .9rem 1rem;
      margin-bottom: .75rem;
    }
    .explanation.show { display: block; animation: fadeIn .22s ease; }
    .expl-label {
      font-family: 'Space Mono', monospace;
      font-size: .6rem;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--accent-g);
      margin-bottom: .35rem;
    }
    .expl-text { font-size: .86rem; line-height: 1.72; color: var(--dim); }

    /* Next button */
    .btn-next {
      width: 100%;
      padding: .85rem;
      border-radius: var(--rl);
      background: var(--accent);
      color: #050d1a;
      font-size: .95rem;
      font-weight: 700;
      transition: all .18s;
    }
    .btn-next:hover:not(:disabled) {
      background: #74b7ff;
      box-shadow: 0 0 22px rgba(79,158,255,.3);
    }
    .btn-next:active:not(:disabled) { transform: scale(.99); }
    .btn-next:disabled {
      background: var(--border);
      color: var(--muted);
      cursor: default;
      box-shadow: none;
    }
    .btn-gemini {
      width: 100%;
      padding: .72rem;
      border-radius: var(--r);
      border: 1px solid var(--border2);
      color: var(--dim);
      font-size: .82rem;
      font-weight: 700;
      margin-top: .6rem;
      transition: all .15s;
    }
    .btn-gemini:hover {
      color: var(--text);
      border-color: var(--accent);
      background: rgba(79,158,255,.08);
    }

    /* -------------------
       RESULT PAGE
    ------------------- */
    .result-page { max-width: 480px; margin: 0 auto; padding: 2rem 1rem 5rem; text-align: center; }

    .result-ring-wrap {
      width: 140px;
      height: 140px;
      position: relative;
      margin: 0 auto 1.5rem;
    }
    .result-ring-wrap svg {
      position: absolute;
      inset: 0;
      transform: rotate(-90deg);
    }
    .result-ring-inner {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .ring-score {
      font-family: 'Space Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
    }
    .ring-denom { font-size: .75rem; color: var(--muted); }

    .result-grade {
      font-size: 1.6rem;
      font-weight: 900;
      letter-spacing: -.02em;
      margin-bottom: .4rem;
    }
    .result-sub { color: var(--muted); font-size: .88rem; margin-bottom: 1.5rem; }

    .result-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--rl);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat { text-align: center; }
    .stat-val {
      font-family: 'Space Mono', monospace;
      font-size: 1.4rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-val.green { color: var(--correct); }
    .stat-val.red   { color: var(--wrong); }
    .stat-label { font-size: .7rem; color: var(--muted); margin-top: .2rem; }

    .result-actions { display: flex; flex-direction: column; gap: .5rem; }
    .btn-retry {
      width: 100%;
      padding: .85rem;
      border-radius: var(--rl);
      background: var(--accent);
      color: #050d1a;
      font-size: .95rem;
      font-weight: 700;
      transition: all .18s;
    }
    .btn-retry:hover { background: #74b7ff; box-shadow: 0 0 22px rgba(79,158,255,.3); }
    .btn-home {
      width: 100%;
      padding: .85rem;
      border-radius: var(--rl);
      border: 1px solid var(--border2);
      color: var(--muted);
      font-size: .9rem;
      font-weight: 700;
      transition: all .15s;
    }
    .btn-home:hover { color: var(--text); border-color: var(--muted); }
    .btn-reset {
      padding: .35rem .65rem;
      border-radius: 8px;
      border: 1px solid #5b2a2a;
      color: #f1b4b4;
      font-size: .72rem;
      font-weight: 700;
      transition: all .15s;
      background: rgba(122, 30, 30, .18);
      white-space: nowrap;
    }
    .btn-reset:hover {
      color: #ffd1d1;
      border-color: #8f3b3b;
      background: rgba(122, 30, 30, .28);
    }

    /* error state */
    .error-box {
      text-align: center;
      padding: 3rem 1rem;
    }
    .error-box h2 { color: var(--wrong); margin-bottom: .5rem; }
    .error-box pre {
      background: var(--card2);
      border-radius: var(--r);
      padding: .75rem;
      font-size: .78rem;
      color: var(--muted);
      margin-top: 1rem;
      text-align: left;
      overflow-x: auto;
    }

    /* scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
  </style>
</head>
<body>
<header class="site-header">
  <div class="logo" onclick="goHome()">
    <span class="logo-dot"></span>
    Quiz<b>Forge</b>
  </div>
  <div style="display:flex; align-items:center; gap:.5rem;">
    <span class="header-tag">JAPANESE</span>
    <button class="btn-reset" onclick="resetQuestionHistory()">履歴リセット</button>
  </div>
</header>

<div class="modal-overlay" id="modal" onclick="handleOverlayClick(event)">
  <div class="modal-box">
    <div class="modal-drag"></div>
    <div class="modal-title">問題数を選択</div>
    <div class="modal-sub">ジャンル: <span class="modal-genre-name" id="modal-genre-name">-</span></div>
    <div class="count-grid" id="count-grid"></div>
    <div class="count-custom">
      <label for="custom-count">カスタム問題数（最大 <span id="max-count-label">?</span> 問）</label>
      <input type="number" id="custom-count" min="1" placeholder="問題数を入力" inputmode="numeric">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
      <button class="btn-start" onclick="confirmStart()">スタート</button>
    </div>
  </div>
</div>

<main>
  <div id="view-home" class="view active">
    <div class="page-wide" id="home-content"></div>
  </div>

  <div id="view-quiz" class="view">
    <div class="page">
      <div class="quiz-nav">
        <a onclick="goHome()">ホーム</a>
        <span class="quiz-nav-sep">›</span>
        <span id="bc-exam">-</span>
        <span class="quiz-nav-sep">›</span>
        <span id="bc-section">-</span>
      </div>

      <div class="quiz-progress">
        <div class="qp-info">
          <div class="qp-row">
            <span id="qp-label">問題 1 / 10</span>
            <span id="qp-pct">0%</span>
          </div>
          <div class="qp-bar-track">
            <div class="qp-bar-fill" id="qp-fill" style="width:0%"></div>
          </div>
        </div>
        <div class="qp-score">
          <div class="qp-score-num" id="qp-score">0</div>
          <div class="qp-score-den" id="qp-denom">/ 10</div>
        </div>
      </div>

      <div class="q-card">
        <div class="q-num" id="q-num">Q1</div>
        <div class="q-text" id="q-text">読み込み中...</div>
      </div>

      <div class="choices" id="choices"></div>

      <div class="result-badge" id="result-badge"></div>
      <div class="explanation" id="explanation">
        <div class="expl-label">解説</div>
        <div class="expl-text" id="expl-text"></div>
      </div>

      <button class="btn-next" id="btn-next" onclick="nextQuestion()" disabled>次の問題へ →</button>
    </div>
  </div>

  <div id="view-result" class="view">
    <div class="result-page">
      <div class="result-ring-wrap">
        <svg viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
          <circle cx="70" cy="70" r="58" fill="none" stroke="#1a2030" stroke-width="11"/>
          <circle cx="70" cy="70" r="58" fill="none"
            stroke="url(#rg)" stroke-width="11"
            stroke-linecap="round"
            stroke-dasharray="364.4"
            stroke-dashoffset="364.4"
            id="ring-arc"/>
          <defs>
            <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#00e5a0"/>
              <stop offset="100%" stop-color="#4f9eff"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="result-ring-inner">
          <div class="ring-score" id="ring-score">0</div>
          <div class="ring-denom" id="ring-denom">/ 10</div>
        </div>
      </div>

      <div class="result-grade" id="result-grade">お疲れさまでした</div>
      <div class="result-sub" id="result-sub">結果を確認してください</div>

      <div class="result-stats">
        <div class="stat">
          <div class="stat-val green" id="stat-ok">0</div>
          <div class="stat-label">正解</div>
        </div>
        <div class="stat">
          <div class="stat-val red" id="stat-ng">0</div>
          <div class="stat-label">不正解</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="stat-pct">0%</div>
          <div class="stat-label">正答率</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="stat-total" style="color:var(--dim)">10</div>
          <div class="stat-label">出題数</div>
        </div>
      </div>

      <div class="result-actions">
        <button class="btn-retry" id="btn-retry" onclick="retryQuiz()">もう一度</button>
        <button class="btn-home" onclick="goHome()">ホームへ戻る</button>
      </div>
    </div>
  </div>
</main>

<script>
/* ---------------------
   STATE
--------------------- */
let allQuestions  = [];   // loaded from JSON
let sessionQs     = [];   // sliced & shuffled for this session
let currentIdx    = 0;
let score         = 0;
let answered      = false;
let currentFile   = '';
let currentExam   = '';
let currentSection = '';
let selectedCount = 10;   // chosen by user
let lastSessionQuestionIds = [];
const QUESTION_STATS_KEY = 'quizforge_question_stats_v1';

function loadQuestionStats() {
  try {
    const raw = localStorage.getItem(QUESTION_STATS_KEY);
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    return (parsed && typeof parsed === 'object') ? parsed : {};
  } catch (_) {
    return {};
  }
}

function saveQuestionStats(stats) {
  try {
    localStorage.setItem(QUESTION_STATS_KEY, JSON.stringify(stats));
  } catch (_) {
    // ignore localStorage write failures
  }
}

function getQuestionStatsEntry(stats, file, qid) {
  const key = `${file}::${qid}`;
  if (!stats[key]) {
    stats[key] = { shown: 0, answered: 0, correct: 0, wrong: 0, lastResult: null, lastAt: 0 };
  }
  return stats[key];
}

function recordQuestionShown(file, qid) {
  const stats = loadQuestionStats();
  const entry = getQuestionStatsEntry(stats, file, qid);
  entry.shown += 1;
  entry.lastAt = Date.now();
  saveQuestionStats(stats);
}

function recordQuestionAnswer(file, qid, ok) {
  const stats = loadQuestionStats();
  const entry = getQuestionStatsEntry(stats, file, qid);
  entry.answered += 1;
  if (ok) entry.correct += 1;
  else entry.wrong += 1;
  entry.lastResult = ok ? 'correct' : 'wrong';
  entry.lastAt = Date.now();
  saveQuestionStats(stats);
}

function buildSessionQuestions(file, questions, count) {
  const stats = loadQuestionStats();
  const prioritized = questions.map((q) => {
    const entry = getQuestionStatsEntry(stats, file, q.id);
    const unanswered = entry.answered === 0 ? 1 : 0;
    const hasWrong = entry.wrong > 0 ? 1 : 0;
    const wrongRate = entry.answered > 0 ? (entry.wrong / entry.answered) : 0;
    return {
      q,
      unanswered,
      hasWrong,
      wrongRate,
      shown: entry.shown,
      rnd: Math.random()
    };
  });

  prioritized.sort((a, b) => {
    // 1) unanswered first
    if (a.unanswered !== b.unanswered) return b.unanswered - a.unanswered;
    // 2) questions with wrong history first
    if (a.hasWrong !== b.hasWrong) return b.hasWrong - a.hasWrong;
    // 3) among wrong-history questions, higher wrong rate first
    if (a.hasWrong && b.hasWrong && a.wrongRate !== b.wrongRate) return b.wrongRate - a.wrongRate;
    // 4) otherwise, less shown first for even distribution
    if (a.shown !== b.shown) return a.shown - b.shown;
    // 5) stable randomness for ties
    return a.rnd - b.rnd;
  });

  return prioritized.slice(0, Math.min(count, prioritized.length)).map((x) => x.q);
}

/* ---------------------
   NAVIGATION
--------------------- */
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + id).classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function goHome() { showView('home'); }

function looksMojibake(text) {
  return !!text && /[縺繧繝蜈ｦ笊窶ｼ｢�]/.test(text);
}

function fallbackById(id, kind) {
  const map = {
    subject: {
      it_exam: 'IT試験',
      programming: 'プログラム言語',
      english: '英語'
    },
    exam: {
      ip: 'ITパスポート試験',
      sg: '情報セキュリティマネジメント試験',
      fe: '基本情報技術者試験',
      ap: '応用情報技術者試験',
      st: 'ITストラテジスト試験',
      sa: 'システムアーキテクト試験',
      pm: 'プロジェクトマネージャ試験',
      nw: 'ネットワークスペシャリスト試験',
      db: 'データベーススペシャリスト試験',
      es: 'エンベデッドシステムスペシャリスト試験',
      sm: 'ITサービスマネージャ試験',
      au: 'システム監査技術者試験',
      sc: '情報処理安全確保支援士試験',
      lang_python: 'Python',
      lang_java: 'Java',
      lang_sql: 'SQL',
      lang_linux: 'Linux',
      english_general: '英語総合'
    }
  };
  if (kind === 'section') {
    return id ? id.replace(/^.*?_/, '').replace(/_/g, ' ') : '';
  }
  return map[kind]?.[id] || id || '';
}

function labelOf(obj, kind) {
  const raw = obj?.name || '';
  return looksMojibake(raw) || !raw ? fallbackById(obj?.id, kind) : raw;
}

/* ---------------------
   INIT / HOME
--------------------- */
async function init() {
  try {
    const res = await fetch('data/genres.json');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    renderHome(data);
  } catch (e) {
    document.getElementById('home-content').innerHTML = `
      <div class="error-box">
        <h2>データ読み込みエラー</h2>
        <p>Webサーバー経由でアクセスしてください。</p>
        <pre>npx serve .\n# または\npython3 -m http.server 8080</pre>
      </div>`;
  }
}

function renderHome(data) {
  const wrap = document.getElementById('home-content');
  let html = `
    <div class="hero">
      <h1 class="hero-title">試験で<em>実力</em>をつける</h1>
      <p class="hero-sub">ジャンルを選んで問題数を決めてスタート。解説で理解を深めましょう。※問題は生成AIで作成しているため、内容に誤りがある場合があります。</p>
    </div>`;

  for (const subject of data.subjects) {
    const subjectName = labelOf(subject, 'subject');
    const subjectDesc = looksMojibake(subject.description) ? '' : (subject.description || '');
    html += `<div class="subject-block">
      <div class="subject-head">
        <span class="subject-head-icon">${subject.icon}</span>
        <span class="subject-head-name">${subjectName}</span>
        <span class="subject-head-desc">${subjectDesc}</span>
      </div>`;

    for (const exam of subject.exams) {
      const examName = labelOf(exam, 'exam');
      const examLevel = looksMojibake(exam.level) ? '' : (exam.level || '');
      html += `
        <div class="exam-block" id="exam-${exam.id}">
          <button class="exam-trigger" onclick="toggleExam('${exam.id}')">
            <span class="exam-badge"
              style="background:${exam.color}22;color:${exam.color};border:1px solid ${exam.color}44">
              ${exam.short}
            </span>
            <span class="exam-name">${examName}</span>
            <span class="exam-level">${examLevel}</span>
            <span class="exam-arrow">▼</span>
          </button>
          <div class="sections-wrap">
            <div class="sections-grid">`;

      for (const sec of exam.sections) {
        const cs = !!sec.coming_soon;
        const sectionName = labelOf(sec, 'section');
        const sectionDesc = looksMojibake(sec.description) ? '' : (sec.description || '');
        html += `
          <div class="sec-card${cs ? ' coming' : ''}"
            style="--c:${exam.color}"
            ${cs ? '' : `onclick="openModal('${sec.file}','${examName}','${sectionName}',${sec.count})"`}>
            <div class="sec-icon">${sec.icon}</div>
            <div class="sec-name">${sectionName}</div>
            <div class="sec-desc">${sectionDesc}</div>
            ${cs
              ? `<span class="sec-soon">準備中</span>`
              : `<div class="sec-count" style="color:${exam.color}">${sec.count}問</div>`}
          </div>`;
      }

      html += `</div></div></div>`; // grid / wrap / exam-block
    }
    html += `</div>`; // subject-block
  }

  wrap.innerHTML = html;
}

function toggleExam(id) {
  document.getElementById('exam-' + id).classList.toggle('open');
}

/* ---------------------
   MODAL (question count picker)
--------------------- */
const PRESETS = [10, 20, 50, 100];

function openModal(file, exam, section, totalCount) {
  currentFile    = file;
  currentExam    = exam;
  currentSection = section;

  document.getElementById('modal-genre-name').textContent = section;
  document.getElementById('max-count-label').textContent  = totalCount;
  document.getElementById('custom-count').value = '';
  document.getElementById('custom-count').max = totalCount;

  // Build preset buttons (only those 竕､ totalCount)
  const grid = document.getElementById('count-grid');
  grid.innerHTML = '';
  let defaultSet = false;

  PRESETS.forEach(n => {
    if (n > totalCount) return;
    const btn = document.createElement('button');
    btn.className = 'count-btn' + (n === 10 ? ' selected' : '');
    btn.innerHTML = `<div class="count-btn-num">${n}</div><div class="count-btn-label">問</div>`;
    btn.onclick = () => selectPreset(n);
    grid.appendChild(btn);
    if (n === 10) { selectedCount = 10; defaultSet = true; }
  });

  // If 10 not available, select first
  if (!defaultSet) {
    const available = PRESETS.filter(n => n <= totalCount);
    selectedCount = available.length ? available[0] : totalCount;
    grid.querySelector('.count-btn')?.classList.add('selected');
  }

  // If totalCount itself isn't a preset, add "全問" button
  if (!PRESETS.includes(totalCount)) {
    const btn = document.createElement('button');
    btn.className = 'count-btn';
    btn.innerHTML = `<div class="count-btn-num">${totalCount}</div><div class="count-btn-label">全問</div>`;
    btn.onclick = () => selectPreset(totalCount);
    grid.appendChild(btn);
  }

  document.getElementById('modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function selectPreset(n) {
  selectedCount = n;
  document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  document.getElementById('custom-count').value = '';
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
  document.body.style.overflow = '';
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal')) closeModal();
}

function confirmStart() {
  const custom = document.getElementById('custom-count').value;
  if (custom) {
    const n = parseInt(custom, 10);
    if (!n || n < 1) { alert('1以上の問題数を入力してください。'); return; }
    selectedCount = n;
  }
  closeModal();
  startQuiz(currentFile, currentExam, currentSection, selectedCount);
}

/* ---------------------
   QUIZ
--------------------- */
async function startQuiz(file, exam, section, count, fixedQuestionIds = null) {
  try {
    const res = await fetch(file);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    allQuestions = data.questions;
    if (Array.isArray(fixedQuestionIds) && fixedQuestionIds.length) {
      const qMap = new Map(allQuestions.map((q) => [q.id, q]));
      sessionQs = fixedQuestionIds.map((id) => qMap.get(id)).filter(Boolean);
    } else {
      sessionQs = buildSessionQuestions(file, allQuestions, count);
    }
    lastSessionQuestionIds = sessionQs.map((q) => q.id);

    currentIdx = 0;
    score = 0;
    currentExam    = exam;
    currentSection = section;

    document.getElementById('bc-exam').textContent    = exam;
    document.getElementById('bc-section').textContent = section;
    document.getElementById('qp-denom').textContent   = '/ ' + sessionQs.length;

    showView('quiz');
    renderQuestion();
  } catch(e) {
    alert('問題ファイルを読み込めませんでした。\nWebサーバー経由でアクセスしてください。\n\n' + e);
  }
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function ensureGeminiButton() {
  if (document.getElementById('btn-gemini')) return;
  const nextBtn = document.getElementById('btn-next');
  if (!nextBtn || !nextBtn.parentElement) return;
  const btn = document.createElement('button');
  btn.className = 'btn-gemini';
  btn.id = 'btn-gemini';
  btn.textContent = 'この問題の詳細を調べる';
  btn.onclick = askGeminiAboutCurrentQuestion;
  nextBtn.insertAdjacentElement('afterend', btn);
}

function buildGeminiPrompt(q, exam, section) {
  const keys = ['A', 'B', 'C', 'D', 'E', 'F'];
  const choiceLines = q.choices.map((c, i) => `${keys[i]}. ${c}`).join('\n');
  const answerText = q.choices[q.answer] ?? '';
  return [
    '以下の問題を日本語で解説してください。',
    `カテゴリ: ${exam} / ${section}`,
    '',
    `問題: ${q.question}`,
    '',
    '選択肢:',
    choiceLines,
    '',
    `正答: ${answerText}`,
    `解説: ${q.explanation}`,
    '',
    '依頼:',
    '1) 正答の根拠',
    '2) 不正解選択肢の誤り',
    '3) 関連ポイントの補足'
  ].join('\n');
}

async function askGeminiAboutCurrentQuestion() {
  const q = sessionQs[currentIdx];
  if (!q) return;
  const prompt = buildGeminiPrompt(q, currentExam, currentSection);

  let copied = false;
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(prompt);
      copied = true;
    }
  } catch (_) {
    copied = false;
  }

  if (!copied) {
    try {
      const ta = document.createElement('textarea');
      ta.value = prompt;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      copied = document.execCommand('copy');
      document.body.removeChild(ta);
    } catch (_) {
      copied = false;
    }
  }

  window.open('https://gemini.google.com/app', '_blank', 'noopener,noreferrer');
  if (copied) {
    alert('Geminiを開きました。質問文をコピー済みです。貼り付けて送信してください。');
  } else {
    alert('Geminiを開きました。コピーできなかったため、問題文を手動で貼り付けてください。');
  }
}
function renderQuestion() {
  answered = false;
  ensureGeminiButton();
  const q     = sessionQs[currentIdx];
  const total = sessionQs.length;
  const pct   = Math.round((currentIdx / total) * 100);
  if (q && q.id) recordQuestionShown(currentFile, q.id);

  document.getElementById('qp-label').textContent = `問題 ${currentIdx+1} / ${total}`;
  document.getElementById('qp-pct').textContent   = pct + '%';
  document.getElementById('qp-fill').style.width  = pct + '%';
  document.getElementById('qp-score').textContent  = score;
  document.getElementById('q-num').textContent     = `Q${currentIdx+1}`;
  document.getElementById('q-text').textContent    = q.question;

  const keys = ['A','B','C','D','E','F'];
  document.getElementById('choices').innerHTML = q.choices.map((c, i) => `
    <button class="choice" onclick="selectAnswer(${i})">
      <span class="choice-key">${keys[i]}</span>
      <span>${c}</span>
    </button>`).join('');

  document.getElementById('result-badge').className  = 'result-badge';
  document.getElementById('explanation').className   = 'explanation';
  const nb = document.getElementById('btn-next');
  nb.disabled = true;
  nb.textContent = (currentIdx < total - 1) ? '次の問題へ →' : '結果を見る →';
}

function selectAnswer(idx) {
  if (answered) return;
  answered = true;

  const q   = sessionQs[currentIdx];
  const btns = document.querySelectorAll('.choice');
  btns.forEach(b => b.disabled = true);

  const ok = (idx === q.answer);
  if (ok) score++;
  if (q && q.id) recordQuestionAnswer(currentFile, q.id, ok);

  btns[q.answer].classList.add('correct');
  if (!ok) btns[idx].classList.add('wrong');

  const badge = document.getElementById('result-badge');
  badge.className = `result-badge show ${ok ? 'correct' : 'wrong'}`;
  badge.textContent = ok ? '正解！' : '不正解';

  document.getElementById('expl-text').textContent = q.explanation;
  document.getElementById('explanation').className = 'explanation show';
  document.getElementById('btn-next').disabled = false;
}

function nextQuestion() {
  currentIdx++;
  if (currentIdx >= sessionQs.length) {
    showResult();
  } else {
    renderQuestion();
  }
}

/* ---------------------
   RESULT
--------------------- */
function showResult() {
  const total = sessionQs.length;
  const pct   = Math.round((score / total) * 100);
  const arc   = 2 * Math.PI * 58; // 364.4

  document.getElementById('ring-score').textContent = score;
  document.getElementById('ring-denom').textContent = '/ ' + total;
  document.getElementById('stat-ok').textContent    = score;
  document.getElementById('stat-ng').textContent    = total - score;
  document.getElementById('stat-pct').textContent   = pct + '%';
  document.getElementById('stat-total').textContent = total;

  // Animate ring
  const ringEl = document.getElementById('ring-arc');
  ringEl.style.strokeDashoffset = arc;
  showView('result');
  setTimeout(() => {
    ringEl.style.transition = 'stroke-dashoffset .9s cubic-bezier(.4,0,.2,1)';
    ringEl.style.strokeDashoffset = arc * (1 - pct / 100);
  }, 80);

  let grade, sub;
  if (pct === 100) {
    grade = 'パーフェクト';
    sub = `${total}問すべて正解です。`;
  } else if (pct >= 80) {
    grade = '優秀';
    sub = `${total}問中${score}問正解（${pct}%）です。`;
  } else if (pct >= 60) {
    grade = '合格圏';
    sub = `${total}問中${score}問正解（${pct}%）です。`;
  } else if (pct >= 40) {
    grade = '要復習';
    sub = `${total}問中${score}問正解（${pct}%）です。もう一度挑戦しましょう。`;
  } else {
    grade = '基礎固め';
    sub = `${total}問中${score}問正解（${pct}%）です。基礎から見直しましょう。`;
  }

  document.getElementById('result-grade').textContent = grade;
  document.getElementById('result-sub').textContent   = sub;
  document.getElementById('btn-retry').textContent = `同じ${total}問でもう一度`;
}

function retryQuiz() {
  startQuiz(currentFile, currentExam, currentSection, sessionQs.length, lastSessionQuestionIds);
}

function resetQuestionHistory() {
  const ok = confirm('\u51fa\u984c\u5c65\u6b74\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u307e\u3059\u304b\uff1f');
  if (!ok) return;
  try {
    localStorage.removeItem(QUESTION_STATS_KEY);
    lastSessionQuestionIds = [];
    alert('\u51fa\u984c\u5c65\u6b74\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u307e\u3057\u305f\u3002');
  } catch (_) {
    alert('\u5c65\u6b74\u306e\u30ea\u30bb\u30c3\u30c8\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002');
  }
}

/* ---------------------
   START
--------------------- */
init();
</script>
</body>
</html>
